'-------------------------------------------------
'--     ***  ExcelHome CopyRight(c)2018  ***    --
'--       《Excel VBA ?典代??用大全》        --
'--     ExceHome ?著出版 ISBN:9787301300954    --
'--                  ??示例                   --
'-------------------------------------------------

'---------------- mdlRecordGroup ----------------
Sub DataGroup()
    Dim cnADO As Object
    Dim rsADO As Object
    Dim strSQL As String
    Dim i As Integer
    Dim strPath As String
    On Error GoTo ErrMsg
    Set cnADO = CreateObject("ADODB.Connection")
    strPath = ThisWorkbook.FullName
    cnADO.Open "Provider=Microsoft.Ace.OLEDB.12.0;" _
        & "Extended Properties=Excel 12.0;" _
        & "Data Source=" & strPath
    strSQL = "SELECT 商品名称,地区," _
        & "SUM(?价)AS 金? ," _
        & "COUNT(*) AS ?数 " _
        & "FROM [?售明?$] " _
        & "WHERE 商品名称 IS NOT NULL " _
        & "GROUP BY 商品名称,地区"
    Set rsADO = cnADO.Execute(strSQL)
    Cells.ClearContents
    For i = 0 To rsADO.Fields.Count - 1
        Cells(1, i + 1) = rsADO(i).Name
    Next i
    Range("a2").CopyFromRecordset rsADO
    rsADO.Close
    cnADO.Close
    Set rsADO = Nothing
    Set cnADO = Nothing
    Exit Sub
ErrMsg:
    MsgBox Err.Description, , "???告"
End Sub

Sub DataGroup2()
    Dim cnADO As Object
    Dim rsADO As Object
    Dim strSQL As String
    Dim i As Integer
    Dim strPath As String
    On Error GoTo ErrMsg
    Set cnADO = CreateObject("ADODB.Connection")
    strPath = ThisWorkbook.FullName
    cnADO.Open "Provider=Microsoft.Ace.OLEDB.12.0;" _
        & "Extended Properties=Excel 12.0;" _
        & "Data Source=" & strPath
    strSQL = "SELECT 商品名称," _
        & "SUM(?价)AS 金? ," _
        & "COUNT(*) AS ?数 " _
        & "FROM [?售明?$] " _
        & "WHERE 商品名称 IS NOT NULL " _
        & "GROUP BY 商品名称"
    Set rsADO = cnADO.Execute(strSQL)
    Cells.ClearContents
    For i = 0 To rsADO.Fields.Count - 1
        Cells(1, i + 1) = rsADO(i).Name
    Next i
    Range("a2").CopyFromRecordset rsADO
    rsADO.Close
    cnADO.Close
    Set rsADO = Nothing
    Set cnADO = Nothing
    Exit Sub
ErrMsg:
    MsgBox Err.Description, , "???告"
End Sub

Sub DataGroup3()
    Dim cnADO As Object
    Dim rsADO As Object
    Dim strSQL As String
    Dim i As Integer
    Dim strPath As String
    On Error GoTo ErrMsg
    Set cnADO = CreateObject("ADODB.Connection")
    strPath = ThisWorkbook.FullName
    cnADO.Open "Provider=Microsoft.Ace.OLEDB.12.0;" _
        & "Extended Properties=Excel 12.0;" _
        & "Data Source=" & strPath
    strSQL = "SELECT 商品名称,地区," _
        & "SUM(?价)AS 金? ," _
        & "COUNT(*) AS ?数 " _
        & "FROM [?售明?$] " _
        & "WHERE 数量>10 AND 地区='北京' " _
        & "GROUP BY 商品名称,地区"
    Set rsADO = cnADO.Execute(strSQL)
    Cells.ClearContents
    For i = 0 To rsADO.Fields.Count - 1
        Cells(1, i + 1) = rsADO(i).Name
    Next i
    Range("a2").CopyFromRecordset rsADO
    rsADO.Close
    cnADO.Close
    Set rsADO = Nothing
    Set cnADO = Nothing
    Exit Sub
ErrMsg:
    MsgBox Err.Description, , "???告"
End Sub

Sub DataGroup4()
    Dim cnADO As Object
    Dim rsADO As Object
    Dim strSQL As String
    Dim i As Integer
    Dim strPath As String
    On Error GoTo ErrMsg
    Set cnADO = CreateObject("ADODB.Connection")
    strPath = ThisWorkbook.FullName
    cnADO.Open "Provider=Microsoft.Ace.OLEDB.12.0;" _
        & "Extended Properties=Excel 12.0;" _
        & "Data Source=" & strPath
    strSQL = "SELECT 商品名称,地区," _
        & "SUM(?价)AS 金? ," _
        & "COUNT(*) AS ?数 " _
        & "FROM [?售明?$] " _
        & "WHERE 数量>10 AND 地区='北京' " _
        & "GROUP BY 商品名称,地区 " _
        & "HAVING SUM(?价)>1000"
    Set rsADO = cnADO.Execute(strSQL)
    Cells.ClearContents
    For i = 0 To rsADO.Fields.Count - 1
        Cells(1, i + 1) = rsADO(i).Name
    Next i
    Range("a2").CopyFromRecordset rsADO
    rsADO.Close
    cnADO.Close
    Set rsADO = Nothing
    Set cnADO = Nothing
    Exit Sub
ErrMsg:
    MsgBox Err.Description, , "???告"
End Sub


